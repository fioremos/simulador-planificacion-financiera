import{MetaAhorro}from"./MetaAhorro.js";import{Movimiento}from"./Movimiento.js";import{StorageUtil}from"../utils/storage.js";import{ApiService}from"../api/apiService.js";export class Planificador{#t;#o;#e;#r;constructor(){this.#t=[],this.#o=[],this.#r=[],this.#e={fechaAscii:"",fechaDesde:"",fechaHasta:"",categoria:"Todas",moneda:"ARS"}}agregarMovimiento(t){try{let o=null;if(t.objetivo){if(o=this.#o.filter((o=>o.id===t.objetivo)),!o)return null;o[0].actualizarMontoActual(t.monto)}const e=new Movimiento(t.fecha,t.tipo,t.categoria,t.nombre,t.monto,t.objetivo,this.diccCategorias.map((t=>t.categoria)).map((t=>t.toLowerCase().replace(/\s/g,""))),this.diccCategorias.flatMap((t=>t.opciones)).map((t=>t.toLowerCase().replace(/\s/g,""))));return this.#t.push(e),e}catch(t){throw new Error("Error al agregar movimiento: "+t.message)}}eliminarMovimiento(t){try{const o=this.#t.findIndex((o=>o.id===t));let e,r=null;return-1!==o&&(e=this.#t[o],e.idObjetivo&&(r=this.#o.filter((t=>t.id===e.idObjetivo))[0],r.actualizarMontoActual(-e.monto)),this.#t.splice(o,1),!0)}catch(t){throw new Error("Error al eliminar movimiento: "+t.message)}}async obtenerCategorias(){try{const t="./api/categorias.json";return await ApiService.fetchData(t,2)}catch(t){return[]}}categoriasPermitidasPorTipo(t){const o=this.diccCategorias;if(0===o.length)throw new Error("No se pudieron cargar las categorÃ­as.");let e=o.filter((o=>o.categoria.toLowerCase()===t.toLowerCase()))[0];return void 0===e||0===e.opciones.length?null:e.opciones.map((t=>t.toLowerCase().replace(/\s/g,"")))}agregarMetaAhorro(t){try{if(this.#o.some((o=>o.nombre.toLowerCase()===t.nombre.toLowerCase())))throw new Error("Meta de ahorro ya existente");{const o=new MetaAhorro(t.nombre,t.montoObjetivo,t.fechaObjetivo);return this.#o.push(o),o}}catch(t){throw new Error("Error al agregar meta de ahorro: "+t.message)}}getMetaByName(t){return this.#o.filter((o=>o.nombre===t))[0]}getPorcentajeMeta(t){return t.getPorcentaje()}obtenerMovimientosPorMeta(t){return this.#t.filter((o=>o.idObjetivo===t))}getMetaById(t){return this.#o.filter((o=>o.id===t))[0]}generarReporte(t,o){const e=this.#a(t),r=this.#i(e),{fechaDesde:a,fechaHasta:i,categoria:s,moneda:n}=t;return this.filtros.fechaAscii=o,this.filtros.categoria=s,this.filtros.moneda=n,this.filtros.fechaHasta=i,this.filtros.fechaDesde=a,{filtrosNuevos:t,datosFiltrados:e,totalMovimientos:e.length,...r}}#a(t){const o=new Date(t.fechaDesde),e=new Date(t.fechaHasta),r=new Date(o.getFullYear(),o.getMonth(),o.getDate()),a=new Date(e.getFullYear(),e.getMonth(),e.getDate());return this.#t.filter((o=>{const e=new Date(o.fecha),i=new Date(e.getFullYear(),e.getMonth(),e.getDate()),s=i>=r&&i<=a,n="Todas"===t.categoria||o.categoria.toLowerCase()===t.categoria.toLowerCase()||"sueldo"===o.categoria.toLowerCase()&&"ingreso"===o.tipo.toLowerCase();return s&&n}))}#i(t){const o={};t.forEach((t=>{o[t.categoria]||(o[t.categoria]={ingreso:0,gasto:0,ahorro:0}),"ingreso"===t.tipo?o[t.categoria].ingreso+=t.monto:"gasto"===t.tipo?o[t.categoria].gasto+=t.monto:"ahorro"===t.tipo&&(o[t.categoria].ahorro+=t.monto)}));const e=t.filter((t=>"ingreso"===t.tipo)).reduce(((t,o)=>t+o.monto),0),r=t.filter((t=>"gasto"===t.tipo)).reduce(((t,o)=>t+o.monto),0),a=t.filter((t=>"ahorro"===t.tipo)).reduce(((t,o)=>t+o.monto),0);return{total:{ingresos:e,gastos:r,ahorro:a,saldo:e-r,porcentajeAhorro:(e>0?a/e*100:0).toFixed(2)},categorias:o}}localToJSON(){return{movimientos:this.movimientos.map((t=>t.toJSON())),metasAhorro:this.metasAhorro.map((t=>t.toJSON()))}}sessionToJSON(){return{filtros:JSON.stringify(this.filtros)}}static localFromJSON(t){const o=new Planificador;return t&&(o.movimientos=t.movimientos.map((t=>Movimiento.fromJSON(t))),o.metasAhorro=t.metasAhorro.map((t=>MetaAhorro.fromJSON(t)))),o}static sessionRepFromJSON(t){t&&(this.filtros=t)}obtenerVariables(t,o){return StorageUtil.obtener("app:"+t,o)}actualizarLocalVariables(t,o,e){switch(t){case"planificador":return StorageUtil.actualizar("app:"+o,this.localToJSON(),"local");case"exportador":return StorageUtil.actualizar("app:"+o,e.localToJSON(),"local");default:return null}}actualizarSessionVariables(t,o,e){switch(t){case"planificador":return StorageUtil.actualizar("app:"+o,this.sessionToJSON(),"session");case"exportador":return StorageUtil.actualizar("app:"+o,e.sessionToJSON(),"session");default:return null}}eliminarVariables(t,o){StorageUtil.eliminar("app:"+t,o)}set filtros(t){t&&"object"==typeof t&&(this.#e=t)}set metasAhorro(t){t&&Array.isArray(t)&&(this.#o=t)}set diccCategorias(t){this.#r=t}set movimientos(t){t&&Array.isArray(t)&&(this.#t=t)}get filtros(){return this.#e}get metasAhorro(){return this.#o}get movimientos(){return this.#t}get diccCategorias(){return this.#r}}