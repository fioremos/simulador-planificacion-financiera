import{Planificador}from"./models/Planificador.js";import{Exportador}from"./models/Exportador.js";import{AlertUtils}from"./utils/alerts.js";import{EventBus}from"./utils/eventBus.js";const trashIcon="assets/images/iconos/Trash_2.png",trashIconAlt="logo_tacho_borrar",reportesOption="reportes",exportadorOption="exportar",loginOption="login",metasOption="metas";let secciones,sidebar,header,principalContainer,offcanvasEl,grafico,metaGrafico,categoriaSelects,filtros={fechaDesde:"",fechaHasta:"",categoria:"",moneda:""},planificador=new Planificador,exportador=new Exportador,opcionesOriginales=new Map;function initExportador(e){if(e){document.querySelector(`#exportar-container input[name="tipoExp"][value="${e.formato}"]`).checked=!0;document.querySelectorAll('#exportar-container input[name="datos"]').forEach((t=>{t.checked=e.tipo.includes(t.value)})),document.querySelector("#nombre").value=e.nombreArchivo,document.querySelector("#ubicacion").value=e.rutaDestino}}function initReportes(e=null){let t;e?(document.getElementById("fechaRyE").value=e.fechaAscii,document.getElementById("categoriaRyE").value=e.categoria,document.getElementById("moneda").value=e.moneda,t=e.fechaAscii,filtros.categoria=e.categoria,filtros.moneda=e.moneda):(t=document.getElementById("fechaRyE").value,filtros.categoria=document.getElementById("categoriaRyE").value,filtros.moneda=document.getElementById("moneda").value),actualizarFechas(t,filtros);const a=planificador.generarReporte(filtros,t);generarGraficoReporte(a.datosFiltrados),actualizarReporteGastos(a)}async function cargarCategoriasActualizarSelects(){try{const e=await planificador.obtenerCategorias(),t=e.filter((e=>""!==e.categoria.trim()));planificador.diccCategorias=t;t.reduce(((e,t)=>e+t.opciones.length),0);e.map((e=>e.opciones)).flat().forEach((e=>{}));let a=Array.from(categoriaSelects);if(a.push(document.getElementById("categoriaRyE")),0===e.length)return void setFeedback("No se pudieron cargar las categorías. Usando fallback de UI.","Error");a.forEach(((e,a)=>{"categoriaRyE"!==e.id&&(e.innerHTML=""),t.forEach((t=>{t.opciones.map((e=>({texto:capitalizar(e),valor:e.toLowerCase().replace(/\s/g,"")}))).forEach((t=>{const o=new Option(t.texto,t.valor);e.appendChild(o),opcionesOriginales.set(a,Array.from(e.options))}))}))}))}catch(e){}}function manejarMovimientoSubmit(e){e.preventDefault();const t=e.target,a={fecha:t.querySelector('input[name="fecha"]').value,tipo:t.querySelector('input[name="tipo"]:checked')?.value||"",categoria:t.querySelector('select[name="categoria"]').value,monto:parseFloat(t.querySelector('input[name="monto"]').value),objetivo:"objetivos"===t.querySelector('select[name="categoria"]').value?t.querySelector('select[name="objetivos"]').value:null,nombre:t.querySelector('select[name="categoria"]')[t.querySelector('select[name="categoria"]').selectedIndex].text};try{const e=planificador.agregarMovimiento(a);planificador.actualizarLocalVariables("planificador","planificador",null),AlertUtils.setFeedback("Movimiento agregado con éxito.","Éxito"),crearFilaMovimiento(a,e),Array.from(document.getElementsByClassName("form-ahorro")).forEach((e=>{e.classList.remove("visible"),e.classList.add("invisible")})),"#dashboard"===window.location.hash&&cerrarModal("miModal"),categoriaSelects.forEach(((e,t)=>{const a=opcionesOriginales.get(t);e.innerHTML="",a.forEach((t=>{e.appendChild(t.cloneNode(!0))})),e.options.length>0&&(e.selectedIndex=0)})),t.reset()}catch(e){AlertUtils.setFeedback(e,"Error"),cerrarModal("miModal")}}function manejarExportar(e){e.preventDefault();const t=document.querySelectorAll('#exportar-container input[name="datos"]:checked'),a=Array.from(t).map((e=>e.value)),o=document.querySelector('#exportar-container input[name="tipoExp"]:checked')?.value,r=document.querySelector("#nombre").value.trim(),n=document.querySelector("#ubicacion").value.trim();try{let[e,t]=exportador.exportarDatos(a,o,r,n,planificador);planificador.actualizarSessionVariables("exportador","exportador:config",exportador),AlertUtils.setFeedback(t,e)}catch(e){AlertUtils.setFeedback(e,"Error")}}function manejarReportes(e){const{id:t,value:a}=e.target;switch(t){case"fechaRyE":actualizarFechas(a,filtros);break;case"categoriaRyE":filtros.categoria=a;break;case"moneda":filtros.moneda=a;break;default:}try{const e=planificador.generarReporte(filtros,document.getElementById("fechaRyE").value);planificador.actualizarSessionVariables("planificador","planificador:filtros",null),generarGraficoReporte(e.datosFiltrados),actualizarReporteGastos(e)}catch(e){AlertUtils.setFeedback(e,"Error")}}function manejarGuardarMeta(e){e.preventDefault();const t=document.getElementById("nombre-objetivo").value,a=document.getElementById("monto-objetivo").value,o=document.getElementById("fecha-objetivo").value;try{const r=planificador.agregarMetaAhorro({nombre:t,montoObjetivo:a,fechaObjetivo:o});planificador.actualizarLocalVariables("planificador","planificador",null),crearFilaMeta(r),actualizarRadiosConMetas(),cerrarModal("MetasAhorroModal"),AlertUtils.setFeedback("Objetivo guardado con éxito","Éxito"),e.target.reset()}catch(e){cerrarModal("MetasAhorroModal"),AlertUtils.setFeedback(e,"Error")}}function manejarMostrarObjetivo(e){e.preventDefault();const t=e.target,a=t.querySelector('input[name="tipo"]:checked');if(!a)return AlertUtils.setFeedback("Selecciona un objetivo.","Warning");const o=planificador.obtenerMovimientosPorMeta(a.value),r=planificador.getMetaById(a.value);o&&r?(actualizarMetaCard(r,o),generarGraficoMeta(o),mostrarMetaCard(!0),cerrarModal("ObjetivosModal"),t.reset()):cerrarModal("ObjetivosModal")}function mostrarSeccion(e){const t=document.getElementById(e);if(!t||t.classList.contains("visible"))return;secciones.forEach((t=>{t.classList.toggle("visible",t.id===e),t.classList.toggle("invisible",t.id!==e)}));const a="login"===e;sidebar&&sidebar.classList.toggle("d-none",a),header&&header.classList.toggle("d-none",a),principalContainer&&principalContainer.classList.toggle("solo-contenido",a),"reportes"===e&&(!planificador.sessionToJSON().filtros.fechaAscii&&planificador.obtenerVariables("planificador:filtros","session")?recargarVariablesSession("reportes"):initReportes()),"metas"===e&&(document.querySelector(".metas-table tbody").innerHTML="",listarMetas(planificador.localToJSON().metasAhorro),mostrarMetaCard(!1)),"exportar"===e&&planificador.obtenerVariables("exportador:config","session")&&recargarVariablesSession("exportar"),"login"===e&&planificador&&(planificador.eliminarVariables("planificador:filtros","session"),filtros={fechaDesde:"",fechaHasta:"",categoria:"",moneda:""},document.getElementById("fechaRyE").value="semana",document.getElementById("categoriaRyE").value="Todas",document.getElementById("moneda").value="ARS",planificador.eliminarVariables("exportador:config","session"),document.querySelector('#exportar-container input[name="tipoExp"]:checked')&&(document.querySelector('#exportar-container input[name="tipoExp"]:checked').checked=!1),document.querySelectorAll('#exportar-container input[name="datos"]').forEach((e=>{e.checked=!1})),document.querySelector("#nombre").value="",document.querySelector("#ubicacion").value="")}function abrirCombo(){const e=document.getElementsByName("objetivos");if(0===planificador.metasAhorro.length)return!1;for(let t=0;t<e.length;t++)e[t]&&void 0!==e[t].innerHTML&&(e[t].innerHTML="");return e.forEach((e=>{planificador.metasAhorro.forEach((t=>{const a=document.createElement("option");a.value=t.id,a.textContent=t.nombre,e.appendChild(a)}))})),Array.from(document.getElementsByClassName("form-ahorro")).forEach((e=>{e.classList.add("visible"),e.classList.remove("invisible")})),!0}function crearFilaMovimiento(e,t){const a=document.querySelector(".movimientos-table tbody"),o=document.createElement("tr");o.dataset.movimientoId=t?t.id:e.id;const r=document.createElement("td");r.classList.add("td-button");const n=document.createElement("button");n.classList.add("btn","small");const i=document.createElement("img");i.src=trashIcon,i.alt=trashIconAlt,n.appendChild(i),r.appendChild(n),n.addEventListener("click",(()=>{planificador.eliminarMovimiento(o.dataset.movimientoId),o.remove(),planificador.actualizarLocalVariables("planificador","planificador",null)}));const c=crearCelda(e.fecha),s=crearCelda(capitalizar(t?e.nombre:e.categoriaNombres)),l=crearCelda(`$${e.monto.toLocaleString()}`);"gasto"===e.tipo.toLowerCase()&&l.classList.add("negative"),"ahorro"===e.tipo.toLowerCase()&&l.classList.add("saving");const d=crearCelda(capitalizar(e.tipo));o.append(r,c,s,l,d),a.appendChild(o)}function generarGraficoReporte(e){const t=getComputedStyle(document.documentElement),a=t.getPropertyValue("--success").trim(),o=t.getPropertyValue("--danger").trim(),r=[...new Set(e.map((e=>new Date(e.fecha).toLocaleDateString())))].sort(((e,t)=>new Date(e)-new Date(t))),n={};e.forEach((e=>{const t=e.categoria;n[t]||(n[t]={tipo:e.tipo,data:Array(r.length).fill(0)});const a=r.indexOf(e.fecha.toLocaleDateString());n[t].data[a]+=e.monto}));const i=Object.keys(n).map((e=>({label:e,data:n[e].data,backgroundColor:"ingreso"===n[e].tipo?a:o})));grafico&&grafico.destroy();const c=document.getElementById("reportes-chart").getContext("2d");grafico=new Chart(c,{type:"bar",data:{labels:r,datasets:i},options:{responsive:!0,plugins:{legend:{display:!1},title:{display:!0,text:"Montos por Categoría y Fecha"},tooltip:{mode:"index",intersect:!1}},scales:{x:{stacked:!0,title:{display:!0,text:"Fecha"}},y:{stacked:!0,beginAtZero:!0,title:{display:!0,text:"Monto ($)"}}}}})}function generarGraficoMeta(e){const t={},a=["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];e.forEach((e=>{const o=e.fecha,r=`${o.getFullYear()}-${o.getMonth().toString().padStart(2,"0")}`;t[r]||(t[r]={montoTotal:0,label:`${a[o.getMonth()]} ${o.getFullYear()}`}),t[r].montoTotal+=e.monto}));const o=Object.keys(t).sort().map((e=>t[e])),r=o.map((e=>e.label)),n=o.map((e=>e.montoTotal));metaGrafico&&metaGrafico.destroy(),metaGrafico=new Chart(document.getElementById("meta-chart").getContext("2d"),{type:"line",data:{labels:r,datasets:[{label:"Ahorro Total por Mes",data:n,backgroundColor:[getComputedStyle(document.documentElement).getPropertyValue("--success").trim()],borderColor:[getComputedStyle(document.documentElement).getPropertyValue("--success").trim()],borderWidth:1}]},options:{responsive:!0,scales:{y:{beginAtZero:!0,title:{display:!0,text:"Monto Ahorrado ($)"}},x:{title:{display:!0,text:"Período"}}},plugins:{title:{display:!0,text:"Ahorro Acumulado por Mes"}}}})}function actualizarReporteGastos(e){const{total:t,categorias:a}=e,o=document.getElementById("gastos-lista"),r=document.querySelector("#reportes .saldo-promedio strong"),n=document.querySelector("#reportes .porcentaje-ahorro strong");o.innerHTML="",Object.entries(a).forEach((([e,a])=>{if(a.gasto<=0)return;const r=document.createElement("div");r.classList.add("row","justify-content-center","gasto-item");const n=document.createElement("div");n.classList.add("col","gastos-list");const i=document.createElement("h4");i.textContent=capitalizar(e),n.appendChild(i);const c=document.createElement("div");c.classList.add("col","gastos-bars");const s=document.createElement("div"),l=t.ingresos>0?a.gasto/t.ingresos*100:0;s.style.width=`${l}%`,s.classList.add("bar"),c.appendChild(s),r.append(n,c),o.appendChild(r)})),r.textContent=`$${t.saldo.toLocaleString("es-AR",{minimumFractionDigits:2})}`,n.textContent=`${t.porcentajeAhorro}%`}function actualizarMetaCard(e,t){let a=0;const o=planificador.getPorcentajeMeta(e);t.forEach((e=>{const t=new Date(e.fecha),o=new Date;t.getMonth()===o.getMonth()&&t.getFullYear()===o.getFullYear()&&(a+=e.monto)})),document.querySelector("#meta-nombre").textContent=e.nombre,document.querySelector("#meta-ahorrado").textContent=`$ ${e.montoActual}`,document.querySelector("#meta-mensaje").innerHTML=`\n        Este mes ingresaste $ ${a}, alcanzaste un \n        ${o}% \n        de tu meta de ahorro.<br>\n        <span class="highlight bold">\n            Solo te faltan $${e.montoObjetivo-e.montoActual}. ¡Vas por muy buen camino!\n        </span>\n    `;const r=document.querySelector("#meta-ahorro"),n=document.querySelector("#meta-porcentaje");r.value=o,n.textContent=`${o} % completado`}function mostrarMetaCard(e=!0){const t=document.querySelector(".meta-card-content");t&&(e?(t.classList.add("visible"),t.classList.remove("invisible")):(t.classList.add("invisible"),t.classList.remove("visible")))}function crearFilaMeta(e){const t=document.querySelector(".metas-table tbody"),a=document.createElement("tr"),o=document.createElement("td");o.textContent=e.nombre;const r=document.createElement("td");r.textContent=`$${e.montoActual.toLocaleString()}`;const n=document.createElement("td"),i=e.montoObjetivo-e.montoActual;n.textContent=`$${i.toLocaleString()}`;const c=document.createElement("td"),s=document.createElement("span");s.classList.add("dot","blue"),c.appendChild(s),a.append(o,r,n,c),t.appendChild(a)}function actualizarRadiosConMetas(){if(!document.querySelector(".metas-table tbody"))return;const e=document.querySelector("#form-objetivo-modal .radio-group");e&&(e.innerHTML="",planificador.metasAhorro.forEach((t=>{const a=t.nombre,o=document.createElement("label"),r=document.createElement("input");r.type="radio",r.name="tipo",r.value=t.id;const n=document.createElement("span");n.classList.add("radio-cuadrado","horizontal"),o.append(r,n,document.createTextNode(" "+a)),e.appendChild(o)})))}function crearCelda(e){const t=document.createElement("td");return t.textContent=e,t}function capitalizar(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}function cerrarModal(e){const t=document.getElementById(e);bootstrap.Modal.getInstance(t)?.hide()}function recargarVariablesSession(e){switch(e){case"reportes":{const e=JSON.parse(planificador.obtenerVariables("planificador:filtros","session").filtros);Planificador.sessionRepFromJSON(e),e&&initReportes(e);break}case"exportar":{const e=JSON.parse(planificador.obtenerVariables("exportador:config","session").filtrosExportador);exportador.sessionExpFromJSON(e),e&&initExportador(e);break}}}function listarMovimientos(e){e.forEach((e=>{crearFilaMovimiento(e)}))}function actualizarFechas(e,t){const a=new Date,o=new Date(a);"semana"===e?o.setDate(a.getDate()-7):"mes"===e?o.setMonth(a.getMonth()-1):"año"===e&&o.setFullYear(a.getFullYear()-1),t.fechaDesde=o.toISOString().split("T")[0],t.fechaHasta=a.toISOString().split("T")[0]}function listarMetas(e){e.forEach((e=>{crearFilaMeta(e)}))}function handleApiLoading(e){e?AlertUtils.setFeedback("Cargando datos...","Loading"):AlertUtils.setFeedback("","closeLoading")}function handleApiError(e){AlertUtils.setFeedback(e,"Error")}document.addEventListener("DOMContentLoaded",(()=>{EventBus.subscribe("api:loading",handleApiLoading),EventBus.subscribe("api:error",handleApiError),categoriaSelects=document.querySelectorAll('select[name="categoria"]'),cargarCategoriasActualizarSelects(),secciones=document.querySelectorAll(".principal-section"),sidebar=document.querySelector(".sidebar"),header=document.getElementById("main-header"),principalContainer=document.querySelector(".principal-main"),offcanvasEl=document.getElementById("sidebarOffcanvas");let e=window.location.hash.replace("#","")||"login";if(!window.location.hash){window.location.hash=e;const t=new URL(window.location);t.searchParams.delete("usuario"),t.searchParams.delete("password"),window.history.replaceState({},"",t)}let t=planificador.obtenerVariables("planificador","local");t&&(0!==t.movimientos.length&&void 0===t.movimientos[0].categoriaNombres?planificador.eliminarVariables("planificador","local"):(planificador=Planificador.localFromJSON(t),listarMovimientos(planificador.localToJSON().movimientos),listarMetas(planificador.localToJSON().metasAhorro),actualizarRadiosConMetas())),mostrarSeccion(e)})),document.body.addEventListener("click",(e=>{const t=e.target.closest('a[href^="#"]');if(!t)return;const a=t.getAttribute("href").substring(1);if(!a)return;const o=document.getElementById(a);if(o&&o.classList.contains("principal-section")&&(e.preventDefault(),window.location.hash!==`#${a}`&&(window.location.hash=a),mostrarSeccion(a),offcanvasEl)){const e=bootstrap.Offcanvas.getInstance(offcanvasEl);e&&e.hide()}})),window.addEventListener("resize",(()=>{if(offcanvasEl&&offcanvasEl.classList.contains("show")){const e=bootstrap.Offcanvas.getInstance(offcanvasEl);e&&e.hide()}})),document.querySelector("#form-ingresos-gastos")&&document.querySelector("#form-ingresos-gastos").addEventListener("submit",manejarMovimientoSubmit),document.querySelector("#form-dashboard-modal")&&document.querySelector("#form-dashboard-modal").addEventListener("submit",manejarMovimientoSubmit),document.querySelector("#exportar-container .btn")&&document.querySelector("#exportar-container .btn").addEventListener("click",manejarExportar),document.getElementById("movimientos-form")&&document.getElementById("movimientos-form").addEventListener("change",manejarReportes),document.querySelector("#form-metas-modal")&&document.querySelector("#form-metas-modal").addEventListener("submit",manejarGuardarMeta),document.querySelector("#form-objetivo-modal")&&document.querySelector("#form-objetivo-modal").addEventListener("submit",manejarMostrarObjetivo),document.querySelectorAll('input[name="tipo"]')&&document.querySelectorAll('input[name="tipo"]').forEach((e=>{e.addEventListener("change",(function(){try{const e=this.value;let t=planificador.categoriasPermitidasPorTipo(e);if(!t||0===t.length)return void AlertUtils.setFeedback(`No hay categorías disponibles para el tipo seleccionado: ${e}.`,"Warning");if(this.checked)if("ahorro"===this.value){if(!abrirCombo())return AlertUtils.setFeedback("No hay metas de ahorro disponibles. Por favor, crea una antes de asignar un movimiento de ahorro.","Warning"),void(this.checked=!1)}else Array.from(document.getElementsByClassName("form-ahorro")).forEach((e=>{e.classList.remove("visible"),e.classList.add("invisible")}));categoriaSelects.forEach(((e,a)=>{const o=opcionesOriginales.get(a);e.innerHTML="",o.forEach((a=>{t.includes(a.value)&&e.appendChild(a.cloneNode(!0))})),e.options.length>0&&(e.selectedIndex=0)}))}catch(e){AlertUtils.setFeedback(e,"Error")}}))}));